<header id="site-header" x-data="{ mobileOpen: false }">

  <!-- ============================= -->
  <!-- EYEBROW BAR -->
  <!-- ============================= -->
  <div id="eyebrow" class="eyebrow">
    <div class="container justify-end md:justify-between">
      <div class="announcement hidden md:block">
        The Shortening Shuttle<sup>®</sup> is proudly <span>Made in the USA</span>
        <img
          src="{{ 'images/made-in-usa.png' | asset_url }}"
          width="50"
          height="26"
          style="display:inline-block;"
        >
      </div>

      <div class="header__icons flex items-center">
        <a
          id="header-cart-link"
          href="{{ routes.cart_url }}"
          class="header-icon {% if cart.item_count > 0 %}cart-has-items{% endif %}"
          aria-label="Cart"
        >
          {{ 'icon-truck.svg' | inline_asset_content }}

          {% if cart.item_count > 0 %}
            <span class="cart-count-badge" aria-live="polite">{{ cart.item_count }}</span>
          {% else %}
            <span class="cart-count-badge hidden" aria-live="polite">0</span>
          {% endif %}
        </a>

      </div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- MAIN NAVIGATION -->
  <!-- ============================= -->
  <div class="navigation">

    <!-- MOBILE MENU BUTTON -->
    <button
      class="lg:hidden mobile-menu-button flex items-center justify-center w-10 h-10"
      @click="mobileOpen = true"
      aria-label="Open Menu"
    >
      {% render 'icon-hamburger' %}
    </button>

    <!-- LOGO -->
    <div class="header__logo">
      <a href="/">
        {{
          section.settings.logo_light
          | image_url: width: 180
          | image_tag: class: '!bg-transparent object-contain'
        }}
      </a>
    </div>

    <!-- DESKTOP NAV -->
    <nav class="desktop-nav hidden lg:block relative" x-data="{ openItem: null }">
      <ul class="flex gap-8 items-center">
        {% for link in section.settings.menu.links %}
          <li
            class="nav-item relative"
            @mouseenter="openItem = {{ forloop.index }}"
            @mouseleave="openItem = null"
          >
            <div class="nav-hover-zone">

              {% if link.links != blank %}
                <button
                  class="nav__parent flex items-center gap-1"
                  :aria-expanded="openItem === {{ forloop.index }}"
                >
                  {{ link.title }}
                  <span class="inline-block ss-arrow">
                    {% render 'chevron-down' %}
                  </span>
                </button>

                <!-- ============================= -->
                <!-- MEGA MENU -->
                <!-- ============================= -->
                <div
                  class="ss-mega-menu"
                  x-show="openItem === {{ forloop.index }}"
                  x-transition
                >
                  <div class="ss-menu-wrapper">

                    {% for child in link.links %}
                      <div class="mega-menu__item space-y-3">

                        <!-- SECONDARY ITEM -->
                        {% assign icon = blank %}
                        {% if child.metafields.custom.icon != blank %}
                          {% assign icon = child.metafields.custom.icon %}
                        {% elsif child.object and child.object.metafields.custom.menu_icon != blank %}
                          {% assign icon = child.object.metafields.custom.menu_icon %}
                        {% endif %}

                        <a
                          href="{{ child.url }}"
                          class="flex items-center gap-3 font-semibold text-gray-800 hover:text-black"
                        >
                          {% if icon != blank %}
                            <img
                              src="{{ icon | image_url: width: 48 }}"
                              class="w-6 h-6 shrink-0 object-contain"
                              alt=""
                            >
                          {% endif %}
                          <span>{{ child.title }}</span>
                        </a>

                        <!-- TERTIARY ITEMS -->
                        {% if child.links != blank %}
                          <ul class="mega-menu__list space-y-2">
                            {% for subchild in child.links %}

                              {% assign icon = blank %}
                              {% if subchild.metafields.custom.icon != blank %}
                                {% assign icon = subchild.metafields.custom.icon %}
                              {% elsif subchild.object and subchild.object.metafields.custom.menu_icon != blank %}
                                {% assign icon = subchild.object.metafields.custom.menu_icon %}
                              {% endif %}

                              <li>
                                <a
                                  href="{{ subchild.url }}"
                                  class="flex items-center gap-3 text-sm text-gray-600 hover:text-gray-900"
                                >
                                  {% if icon != blank %}
                                    <img
                                      src="{{ icon | image_url: width: 48 }}"
                                      class="w-6 h-6 shrink-0 object-contain"
                                      alt=""
                                    >
                                  {% endif %}
                                  <span>{{ subchild.title }}</span>
                                </a>
                              </li>
                            {% endfor %}
                          </ul>
                        {% endif %}

                      </div>
                    {% endfor %}

                  </div>
                </div>

              {% else %}
                <a href="{{ link.url }}" class="nav__link">
                  {{ link.title }}
                </a>
              {% endif %}

            </div>
          </li>
        {% endfor %}
      </ul>
    </nav>
  </div>

  <!-- =============================== -->
  <!-- MOBILE MENU -->
  <!-- =============================== -->
  <div
    class="fixed inset-0 z-50 bg-black bg-opacity-50 lg:hidden"
    x-show="mobileOpen"
    @click.self="mobileOpen = false"
  >
    <div class="absolute left-0 top-0 h-full w-80 bg-white p-6 overflow-y-auto">

      <div class="flex justify-between items-center mb-6">
        <span class="text-xl font-bold">Menu</span>
        <button @click="mobileOpen = false">
          {% render 'icon-close' %}
        </button>
      </div>

      <ul class="space-y-4">
        {% for link in section.settings.menu.links %}
          <li x-data="{ open: false }">

            {% if link.links != blank %}
              <button
                class="flex justify-between items-center w-full font-medium text-gray-800"
                @click="open = !open"
              >
                <span>{{ link.title }}</span>
                {% render 'chevron-down' %}
              </button>

              <ul x-show="open" class="mt-3 ml-4 space-y-4 border-l pl-4">

                {% for child in link.links %}
                  <li x-data="{ open2: false }">

                    {% assign icon = blank %}
                    {% if child.metafields.custom.icon != blank %}
                      {% assign icon = child.metafields.custom.icon %}
                    {% elsif child.object and child.object.metafields.custom.menu_icon != blank %}
                      {% assign icon = child.object.metafields.custom.menu_icon %}
                    {% endif %}

                    {% if child.links != blank %}
                      <button
                        class="flex justify-between items-center w-full text-gray-700"
                        @click="open2 = !open2"
                      >
                        <span class="flex items-center gap-3">
                          {% if icon != blank %}
                            <img src="{{ icon | image_url: width: 32 }}" class="w-4 h-4">
                          {% endif %}
                          {{ child.title }}
                        </span>
                        {% render 'chevron-down' %}
                      </button>

                      <ul x-show="open2" class="mt-2 ml-4 space-y-2 border-l pl-4">
                        {% for subchild in child.links %}

                          {% assign icon = blank %}
                          {% if subchild.metafields.custom.icon != blank %}
                            {% assign icon = subchild.metafields.custom.icon %}
                          {% elsif subchild.object and subchild.object.metafields.custom.menu_icon != blank %}
                            {% assign icon = subchild.object.metafields.custom.menu_icon %}
                          {% endif %}

                          <li>
                            <a
                              href="{{ subchild.url }}"
                              class="flex items-center gap-3 text-gray-600 hover:text-gray-900"
                            >
                              {% if icon != blank %}
                                <img src="{{ icon | image_url: width: 48 }}" class="w-6 h-6">
                              {% endif %}
                              {{ subchild.title }}
                            </a>
                          </li>

                        {% endfor %}
                      </ul>

                    {% else %}
                      <a
                        href="{{ child.url }}"
                        class="flex items-center gap-3 text-gray-700 hover:text-gray-900"
                      >
                        {% if icon != blank %}
                          <img src="{{ icon | image_url: width: 48 }}" class="w-6 h-6">
                        {% endif %}
                        {{ child.title }}
                      </a>
                    {% endif %}

                  </li>
                {% endfor %}

              </ul>
            {% else %}
              <a href="{{ link.url }}" class="block font-medium text-gray-800">
                {{ link.title }}
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

    </div>
  </div>
</header>


<!-- ===================================== -->
<!-- POSITIONING + MEGA MENU BEHAVIOR -->
<!-- ===================================== -->

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const eyebrow = document.getElementById('eyebrow');
    const header = document.getElementById('site-header');
    const megaMenus = document.querySelectorAll('.ss-mega-menu');

    function updateMegaPosition() {
      const eyebrowHeight = eyebrow ? eyebrow.offsetHeight : 0;
      const navHeight = header.querySelector('.navigation').offsetHeight;
      const totalOffset = eyebrowHeight + navHeight;

      megaMenus.forEach((menu) => {
        menu.style.top = `${totalOffset - 1}px`;
      });

      document.body.style.paddingTop = `${totalOffset}px`;
    }

    updateMegaPosition();
    window.addEventListener('resize', updateMegaPosition);
  });
</script>

{% stylesheet %}
  /*********************************************************
 EYEBROW BAR
**********************************************************/
  #eyebrow {
    width: 100%;
    background: #20204b;
    color: white;
    z-index: 1200;
    transition: transform 0.3s ease;
  }

  #eyebrow .container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0.5rem 2rem;
    display: flex;
    align-items: center;
  }

  /*********************************************************
 FIXED HEADER BELOW EYEBROW
**********************************************************/
  #site-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1100;
    background: #ffffff;
  }

  .navigation {
    display: flex;
    height: 5rem;
    align-items: center;
    justify-content: space-between;
    padding: 0 2rem;
    background: #ffffff;
    max-width: 1600px;
    margin: 0 auto;
  }

  /*********************************************************
 APPLE-STYLE HOVER BUFFER ZONE
**********************************************************/
  .nav-hover-zone {
    position: relative;
  }

  .nav-hover-zone::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    height: 20px; /* invisible hover bridge */
    background: transparent;
    pointer-events: auto;
  }

  /*********************************************************
 MEGA MENU — FULL WIDTH, NO FLICKER
**********************************************************/
  .ss-mega-menu {
    position: fixed;
    left: 0;
    width: 100vw;
    background: #ffffff;
    border-top: 3px solid #20204b;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    padding-top: 1px; /* gap fix */
    z-index: 1000;

    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: opacity 0.25s ease, transform 0.25s ease;
  }

  .ss-mega-menu:not([style*='display: none']) {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /*********************************************************
 MEGA MENU GRID
**********************************************************/
  .ss-menu-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2.5rem 2rem;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 3rem;
  }

  /*********************************************************
 TOP-LEVEL NAV LINKS
**********************************************************/
  .nav__link,
  .nav__parent {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #111;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: color 0.2s ease;
  }

  .nav__link:hover,
  .nav__parent:hover {
    color: #20204b;
  }

  /*********************************************************
 MENU LEVELS
**********************************************************/
  .mega-menu__heading {
    display: block;
    font-family: 'Bebas Neue', sans-serif;
    font-weight: 400;
    font-size: 1.6rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    color: #111;
    text-decoration: none;
  }

  .mega-menu__item > a {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.6rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #20204b;
    text-decoration: none;
    transition: color 0.2s ease, letter-spacing 0.2s ease;
  }

  .mega-menu__item > a:hover {
    color: #000;
    letter-spacing: 0.12em;
    text-decoration: none;
  }

  .mega-menu__list {
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 3px solid #20204b;
  }

  .mega-menu__list a {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: #444;
    text-decoration: none;
    transition: color 0.2s ease, padding-left 0.2s ease;
    display: block;
  }

  .mega-menu__list a:hover {
    color: #20204b;
    padding-left: 4px;
    text-decoration: none;
  }

  /*********************************************************
 CHEVRON ANIMATION
**********************************************************/
  .ss-arrow {
    width: 16px;
    height: 16px;
    transition: transform 0.2s ease;
  }

  .nav__parent[aria-expanded='true'] .ss-arrow {
    transform: rotate(180deg);
  }

  /*****************************************************
 HEADER ICONS (ACCOUNT + CART)
*****************************************************/
  .header__icons .header-icon {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    cursor: pointer;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .header__icons .header-icon svg path {
    fill: white!important;
  }

  .header__icons .header-icon:hover {
    opacity: 0.75;
  }

  /*****************************************************
 CART BADGE (When Items Are In Cart)
*****************************************************/
  .cart-count-badge {
    position: absolute;
    top: -6px;
    right: -10px;
    background: #ff3b30; /* Apple-style red badge */
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
  }

  /*****************************************************
 OPTIONAL: Hover scaling for premium feel
*****************************************************/
  .header-icon:hover {
    transform: scale(1.08);
  }

  .mobile-menu-button svg {
    width: 28px;
    height: 28px;
  }

  .cart-count-badge {
    position: absolute;
    top: -4px;
    right: -8px;
    background: #ff3b30;
    color: white;
    font-size: 0.7rem;
    line-height: 1;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Header",
  "settings": [
    { "type": "image_picker", "id": "logo_light", "label": "Logo" },
    { "type": "link_list", "id": "menu", "label": "Menu" }
  ]
}
{% endschema %}
