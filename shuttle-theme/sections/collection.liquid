{% comment %}
  Collection grid with AJAX add-to-cart + toast + cart count update + a11y focus
{% endcomment %}

<div class="container mx-auto collection-grid">
  {% paginate collection.products by 20 %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-10">
      {% for product in collection.products %}
        {% if product.title != null %}
          <div class="flex flex-col items-center bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden">

            <!-- Image -->
            <a href="{{ product.url }}" class="block w-full overflow-hidden">
              <div class="relative collection-card__media">
                <img
                  src="{{ product.featured_image | image_url: width: 600, height: 600, crop: 'center' }}"
                  alt="{{ product.featured_image.alt | escape }}"
                  width="600"
                  height="600"
                  class="collection-card__image rounded-t-2xl transition duration-500 group-hover:scale-105"
                  loading="lazy"
                >
                <div class="absolute inset-0 bg-blue-500 opacity-0 group-hover:opacity-10 transition duration-500 rounded-t-2xl"></div>
              </div>
            </a>

            <!-- Content -->
            <div class="p-6 text-center flex flex-col flex-grow">
              <a href="{{ product.url }}" class="item-title block text-xl font-semibold text-gray-900 mb-2 group-hover:ss-text-blue transition">
                {{ product.title | escape }}
              </a>

              {% assign subtitle = product.metafields.descriptors.subtitle | default: product.description | strip_html | truncate: 90 %}
              <p class="text-sm text-gray-500 mb-4">{{ subtitle }}</p>

              <div class="flex justify-center items-baseline gap-2 mb-4">
                {% if product.price_varies %}
                  <span class="text-lg font-bold text-gray-900">{{ product.price_min | money }} ‚Äì {{ product.price_max | money }}</span>
                {% else %}
                  <span class="text-lg font-bold text-gray-900">{{ product.price | money }}</span>
                {% endif %}
                {% if product.compare_at_price_max > product.price %}
                  <span class="text-sm line-through text-gray-400">{{ product.compare_at_price_max | money }}</span>
                {% endif %}
              </div>

              <!-- CTAs -->
              <div class="mt-auto space-y-2">
                <a href="{{ product.url }}" class="ss-btn inline-flex items-center justify-center w-full rounded-xl bg-gray-900 px-5 py-3 text-sm font-semibold text-white hover:bg-gray-800 transition">
                  View Product
                </a>

                {% if product.available %}
                  {% if product.variants.size == 1 %}
                    <button
                      type="button"
                      class="add-to-cart-btn inline-flex items-center justify-center w-full rounded-xl border border-gray-900 px-5 py-3 text-sm font-semibold text-gray-900 hover:bg-gray-50 transition"
                      data-variant-id="{{ product.variants.first.id }}"
                      data-product-title="{{ product.title | escape }}"
                    >
                      Add to Cart
                    </button>
                  {% else %}
                    <a href="{{ product.url }}" class="ss-btn inline-flex items-center justify-center w-full rounded-xl border border-gray-900 px-5 py-3 text-sm font-semibold text-gray-900 hover:bg-gray-50 transition">
                      Choose Options
                    </a>
                  {% endif %}
                {% else %}
                  <span class="ss-btn inline-flex items-center justify-center w-full rounded-xl bg-gray-200 px-5 py-3 text-sm font-semibold text-gray-400 cursor-not-allowed">
                    Sold Out
                  </span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {% if paginate.pages > 1 %}
      <nav class="mt-12 flex justify-center" aria-label="Pagination">
        <ul class="inline-flex items-center gap-2 rounded-xl bg-white p-2 shadow-sm ring-1 ring-gray-200">
          {% if paginate.previous %}
            <li><a href="{{ paginate.previous.url }}" class="inline-flex h-10 items-center gap-2 rounded-lg bg-gray-900 px-4 text-sm font-semibold text-white hover:bg-gray-800 transition">‚Üê Prev</a></li>
          {% endif %}
          {% for part in paginate.parts %}
            <li>
              {% if part.is_link %}
                <a href="{{ part.url }}" class="inline-flex h-10 min-w-[2.5rem] items-center justify-center rounded-lg border border-gray-300 bg-white px-4 text-sm font-semibold text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition">{{ part.title }}</a>
              {% elsif part.title == paginate.current_page %}
                <span class="inline-flex h-10 min-w-[2.5rem] items-center justify-center rounded-lg bg-blue-700 px-4 text-sm font-bold text-white" aria-current="page">{{ part.title }}</span>
              {% endif %}
            </li>
          {% endfor %}
          {% if paginate.next %}
            <li><a href="{{ paginate.next.url }}" class="inline-flex h-10 items-center gap-2 rounded-lg bg-gray-900 px-4 text-sm font-semibold text-white hover:bg-gray-800 transition">Next ‚Üí</a></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% endpaginate %}
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container" aria-live="polite"></div>

<script>
  let isAddingToCart = false;

  function showToast(message) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('is-visible'));
    setTimeout(() => {
      toast.classList.remove('is-visible');
      setTimeout(() => toast.remove(), 300);
    }, 2200);
  }

  function updateCartCount(count) {
    const badge = document.querySelector('.cart-count-badge');
    if (!badge) return;
    badge.textContent = count;
    badge.classList.remove('hidden');
  }

  function focusCartIcon() {
    const cartLink = document.getElementById('header-cart-link');
    if (!cartLink) return;
    cartLink.focus({ preventScroll: true });
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.add-to-cart-btn');
    if (!btn) return;

    e.preventDefault();

    if (isAddingToCart) return; // üîí Global guard
    isAddingToCart = true;

    const variantId = btn.getAttribute('data-variant-id');
    const title = btn.getAttribute('data-product-title') || 'Item';

    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Adding‚Ä¶';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: variantId, quantity: 1 })
    })
      .then(res => {
        if (!res.ok) throw new Error('Add to cart failed');
        return res.json();
      })
      .then(() => fetch('/cart.js'))
      .then(res => res.json())
      .then(cart => {
        btn.textContent = 'Added';
        showToast(`${title} added to cart`);
        updateCartCount(cart.item_count);
        focusCartIcon();
      })
      .catch(err => {
        console.error(err);
        btn.textContent = 'Error ‚Äì Try Again';
      })
      .finally(() => {
        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
          isAddingToCart = false; // üîì release lock
        }, 1200);
      });
  });
</script>


{% stylesheet %}
  .collection-grid { padding: 5rem 2rem; margin: 0 auto; }
  .collection-card__media { position: relative; width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background: #f7f7f7; }
  .collection-card__image { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
  .add-to-cart-btn {text-transform: uppercase;}
  .ss-btn{text-transform: uppercase;}
  .toast-container { position: fixed; right: 1.25rem; bottom: 1.25rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
  .toast { background: rgba(17,24,39,.95); color: #fff; padding: .6rem .9rem; border-radius: .75rem; font-size: .85rem; box-shadow: 0 10px 24px rgba(0,0,0,.25); opacity: 0; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; }
  .toast.is-visible { opacity: 1; transform: translateY(0); }
  @media (max-width: 768px) {
    .collection-grid { padding: 3rem 1.25rem; }
    .collection-grid a.item-title { font-size: 1.1rem; }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:general.collection",
  "settings": []
}
{% endschema %}